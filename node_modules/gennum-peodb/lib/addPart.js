//============================================================================//

var print = console.log;

var peodbUtils = require('../peodbUtils');

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'part_type_id',
    'part_number',
    'sap_type',
    'description',
  ];

  PEODB.prototype.addPart = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkUserRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addPart(db, args, cb);
      }, cb);
    });
  }

  function addPart(db, args, cb) {
    db.transaction(function(cb) {
      peodbUtils.createObject(db, 'part', args.user_id, function(err, object_id) {
        if (err) {
          return cb(err);
        }
        var qStr = [
          'INSERT INTO parts (',
          '    part_id, object_id, part_type_id',
          '  , part_number, sap_type',
          '  , description, state',
          ') VALUES (',
          '  NULL',
          ',' + db.escape(object_id),
          ',' + db.escape(args.part_type_id),
          ',' + db.escape(args.part_number),
          ',' + db.escape(args.sap_type),
          ',' + db.escape(args.description),
          ',"ACTIVE")',
        ].join('\n');

        db.queryData(qStr, function(err, data) {
          if (err) {
            return cb(err);
          }
          return cb(null, data.insertId);
        });
      });
    },
    cb);
  }
}

//============================================================================//
