//============================================================================//

var print = console.log;

var peodbUtils = require('../peodbUtils');

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'root_part_id',
    'name',
    'description',
  ];

  PEODB.prototype.addPartflow = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkUserRole(args, 'Admin', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addPartflow(db, args, cb);
      }, cb);
    });
  }

  function addPartflow(db, args, cb) {
    db.transaction(function(cb) {
      peodbUtils.createObject(db, 'partflow', args.user_id, function(err, object_id) {
        var qStr = [
          'INSERT INTO partflows (',
          '  partflow_id, object_id, root_part_id, name, description',
          ') VALUES (',
          '  NULL',
          ',' + db.escape(object_id),
          ',' + db.escape(args.root_part_id),
          ',' + db.escape(args.name),
          ',' + db.escape(args.description),
          ')',
        ].join('\n');

        db.queryData(qStr, function(err, data) {
          if (err) {
            return cb(err);
          }
          return cb(null, data.insertId);
        });
      });
    },
    cb);
  }
}

//============================================================================//
