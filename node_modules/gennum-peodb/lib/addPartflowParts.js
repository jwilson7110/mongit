//============================================================================//

var print = console.log;

//============================================================================//

var async = require('async');

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'partflow_id',
    'part_ids',
  ];

  PEODB.prototype.addPartflowParts = function(args, cb) {
    var peodb = this;

    if (args.part_id && !args.part_ids) {
      args.part_ids = [ args.part_id ];
    }

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkPartflowRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args,
        function(db, cb) {
          addPartflowParts(peodb, db, args, cb);
        },
        function(err) {
          if (!err) {
            peodb.triggerEmails();
          }
          return cb(err);
        }
      );
    });
  }

  function addPartflowParts(peodb, db, args, cb) {
    db.transaction(function(cb) {
      var partflow_id = db.escape(args.partflow_id);
      var qStr =
        'INSERT INTO partflow_parts (partflow_id, part_id) VALUES ';
      for (var i = 0; i < args.part_ids.length; i++) {
        var part_id = db.escape(args.part_ids[i]);
        if (i != 0) {
          qStr += ',';
        }
        qStr +=  '(' + partflow_id + ',' + part_id + ')';
      }
      db.queryData(qStr, function(err, data) {
        if (err) {
          return cb(err);
        }

        var copyArgs = { db: db,
          user_id:     args.user_id,
          partflow_id: partflow_id,
        };

        async.forEachSeries(args.part_ids,
          function(part_id, cb) {
            copyArgs.part_id = part_id;
            peodb.copyRolesPartflow2Part(copyArgs, cb);
          },
        cb);
      });
    },
    cb);
  }
}

//============================================================================//
