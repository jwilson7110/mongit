//============================================================================//

var print = console.log;

//============================================================================//

var async = require('async');

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'partflow_id',
    'step_ids',
  ];

  PEODB.prototype.addPartflowSteps = function(args, cb) {
    var peodb = this;

    if (args.step_id && !args.step_ids) {
      args.step_ids = [ args.step_id ];
    }

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkPartflowRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args,
        function(db, cb) {
          addPartflowSteps(peodb, db, args, cb);
        },
        function(err) {
          if (!err) {
            peodb.triggerEmails();
          }
          return cb(err);
        }
      );
    });
  }

  function addPartflowSteps(peodb, db, args, cb) {
    db.transaction(function(cb) {
      var partflow_id = db.escape(args.partflow_id);
      var qStr =
        'INSERT INTO partflow_steps (partflow_id, step_id) VALUES ';
      for (var i = 0; i < args.step_ids.length; i++) {
        var step_id = db.escape(args.step_ids[i]);
        if (i != 0) {
          qStr += ',';
        }
        qStr +=  '(' + partflow_id + ',' + step_id + ')';
      }
      db.queryData(qStr, function(err, data) {
        if (err) {
          return cb(err);
        }

        var copyArgs = { db: db,
          user_id:     args.user_id,
          partflow_id: partflow_id,
        };

        async.forEachSeries(args.step_ids,
          function(step_id, cb) {
            copyArgs.step_id = step_id;
            peodb.copyRolesPartflow2Step(copyArgs, cb);
          },
        cb);
      });
    },
    cb);
  }
}

//============================================================================//
