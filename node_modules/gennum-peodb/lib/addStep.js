//============================================================================//

var print = console.log;

var peodbUtils = require('../peodbUtils');

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'step_type_id',
  ];

  PEODB.prototype.addStep = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkPartflowRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addStep(db, args, cb);
      }, cb);
    });
  }

  function addStep(db, args, cb) {
    db.transaction(function(cb) {
      peodbUtils.createObject(db, 'step', args.user_id, function(err, object_id) {
        var qStr = [
          'INSERT INTO steps (',
          '  step_id, object_id, step_type_id, state',
          ') VALUES (',
          '  NULL',
          ',' + db.escape(object_id),
          ',' + db.escape(args.step_type_id),
          ',"ACTIVE")',
        ].join('\n');

        db.queryData(qStr, function(err, data) {
          if (err) {
            return cb(err);
          }
          return cb(null, data.insertId);
        });
      });
    },
    cb);
  }
}

//============================================================================//
