//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'part_id',
    'step_id',
  ];

  PEODB.prototype.addStepOutput = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    if (typeof(args.count) === 'undefined') {
      args.count = 1;
    }

    peodb.checkPartflowRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addStepOutput(db, args, cb);
      }, cb);
    });
  }

  function addStepOutput(db, args, cb) {
    db.transaction(function(cb) {
      var qStr = [
        'INSERT INTO step_outputs (',
        '  step_output_id, step_id, part_id, count',
        ') VALUES (',
        '  NULL',
        ',' + db.escape(args.step_id),
        ',' + db.escape(args.part_id),
        ',' + db.escape(args.count),
        ')',
      ].join('\n');

      db.queryData(qStr, function(err, data) {
        if (err) {
          return cb(err);
        }
        return cb(null, data.insertId);
      });
    },
    cb);
  }
}

//============================================================================//
