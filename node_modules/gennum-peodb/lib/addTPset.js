//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'partflow_id',
    'tp_stage_id',
    'step_id',
    'product_code',
    'name',
  ];

  PEODB.prototype.addTPset = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkPartflowRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addTPset(peodb, db, args, cb);
      }, cb);
    });
  }

  // NOTE: the roles are already attached to the tp_set's step

  function addTPset(peodb, db, args, cb) {
    var user_id_str  = db.escape(args.user_id);
    var partflow_id  = db.escape(args.partflow_id);
    var tp_stage_id  = db.escape(args.tp_stage_id);
    var step_id      = db.escape(args.step_id);
    var product_code = db.escape(args.product_code);
    var name         = db.escape(args.name);
    db.transaction(function(cb) {
      var qStr =
        'SELECT 1 FROM partflow_steps'
      + ' WHERE step_id = ' + step_id
      + '   AND partflow_id = ' + partflow_id
      ;
      db.queryData(qStr, function(err, data) {
        if (err) {
          return cb(err);
        }
        if (data.rows.length !== 1) {
          return cb(Error(
            'step_id=' + step_id + ' is not in partflow_id=' +  partflow_id
          ));
        }
        var qStr =
          'INSERT INTO tp_sets ('
        + '  tp_set_id, partflow_id, tp_stage_id, step_id'
        + ', name, product_code, create_user_id, create_time'
        + ') VALUES ('
        + 'NULL'
        + ',' + partflow_id + ',' + tp_stage_id + ',' + step_id
        + ',' + name + ',' + product_code + ',' + user_id_str
        + ',UNIX_TIMESTAMP()'
        + ')'
        ;
        db.queryData(qStr, function(err, data) {
          if (err) {
            return cb(err);
          }
          return cb(null, data.insertId);
        });
      });
    },
    cb);
  }
}

//============================================================================//
