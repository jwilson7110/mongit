//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'ldap_id',
    'name',
    // 'callsign'
    // 'phone'
    // 'mobile'
    // 'email'
    // 'fax'
    // 'title'
    // 'location'
  ];

  PEODB.prototype.addUser = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkUserRole(args, 'Admin', function(err) {
      if (err) {
        return cb(err);
      }
      peodb.dbSession(args, function(db, cb) {
        addUser(db, args, cb);
      }, cb);
    });
  }

  function addUser(db, args, cb) {
    db.transaction(function(cb) {
      var fields = [
        'user_id'
      , 'ldap_id'
      , 'name'
      , 'state'
      ];
      var values = [
        db.escape(args.ldap_id)
      , db.escape(args.ldap_id)
      , db.escape(args.name)
      , db.escape('ACTIVE')
      ];

      var extras = [
        'callsign'
      , 'phone'
      , 'mobile'
      , 'email'
      , 'fax'
      , 'title'
      , 'location'
      , 'manager_id'
      ];
      for (var i = 0; i < extras.length; i++) {
        var field = extras[i];
        var value = args[field];
        fields.push(field);
        values.push(value ? db.escape(value) : 'NULL');
      }

      var fieldsStr = fields.join(',');
      var valuesStr = values.join(',');

      var onDupClause = '';
      if (!args.noUpdate) {
        var updates = [];
        for (var i = 2; i < fields.length; i++) { // skip user_id & ldap_id
          updates.push(fields[i] + '=' + values[i]);
        }
        updatesStr = updates.join(',');
        onDupClause = ' ON DUPLICATE KEY UPDATE ' + updatesStr;
      }

      var qStr =
        'INSERT INTO users (' + fieldsStr + ') VALUES (' + valuesStr + ')'
      + onDupClause
      ;

      db.queryData(qStr, cb);
    },
    cb);
  }
}

//============================================================================//
