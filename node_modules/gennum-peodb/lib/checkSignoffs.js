//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'tp_rev_id',
  ];

  PEODB.prototype.checkSignoffs = function(args, cb) {
    var peodb = this;

    if (!(args instanceof Object)) {
      args = { tp_rev_id: args };
    }

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.dbSession(args, function(db, cb) {

      var qStr =
        'SELECT s.state, s.stale'
      + ' FROM tp_revs        tr'
      + ' JOIN audits         a  ON (a.tp_rev_id = tr.tp_rev_id)'
      + ' JOIN audit_types    at ON (at.audit_type_id = a.audit_type_id)'
      + ' JOIN audit_signoffs sa ON (sa.audit_id = a.audit_id)'
      + ' JOIN signoffs       s  ON (s.signoff_id = sa.signoff_id)'
      + ' JOIN role_types     rt ON (rt.role_type_id = s.role_type_id)'
      + ' WHERE tr.tp_rev_id = ' + db.escape(args.tp_rev_id)
      +   ' AND at.tp_rev_state = tr.state'
      +   ' AND rt.brief <> "PRU"' // ignore automated entries
      ;

      db.queryData(qStr, function(err, data) {
        if (err) {
          return cb(err);
        }
        var results = {
          'NULL':   0,
          'PASS':   0,
          'FAIL':   0,
          'WAIVER': 0,
          'STALE':  0,
        };
        var rows = data.rows;
        for (var r = 0; r < rows.length; r++) {
          var row = rows[r];
          var state = (row.state === null) ? 'NULL' : row.state;
          if (typeof(results[state]) !== 'number') {
            results[state] = 0;
          }
          results[state] += 1;
          if (row.stale) {
            results.STALE += 1;
          }
        }
        return cb(null, results);
      });
    },
    cb);
  }
}

//============================================================================//
