//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'tp_rev_id',
    'company_id',
    'action',  // 'insert' or 'delete'
  ];

  PEODB.prototype.editTPrevTestHouse = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.checkTPrevRole(args, 'PE', function(err) {
      if (err) {
        return cb(err);
      }
      switch (args.action) {
        case 'insert': {
          peodb.dbSession(args, function(db, cb) {
            insertTestHouse(peodb, db, args, cb);
          }, cb);
          break;
        }
        case 'delete': {
          peodb.dbSession(args, function(db, cb) {
            deleteTestHouse(peodb, db, args, cb);
          }, cb);
          break;
        }
        default: {
          return cb(Error('editTPrevTestHouse() invalid action'));
        }
      }
    });
  }

  function insertTestHouse(peodb, db, args, cb) {
    db.transaction(function(cb) {
      // make sure that the company_id is a valid test house
      var qStr =
        'SELECT 1 FROM test_houses WHERE company_id = '
      + db.escape(args.company_id)
      ;
      db.query1Value(qStr, function(err) {
        if (err) {
          return cb(err);
        }
        // find the tp_rev's step_id
        var qArgs = { db: db, tp_rev_id: args.tp_rev_id };
        peodb.getTPrevStepID(qArgs, function(err, step_id) {
          if (err) {
            return cb(err);
          }
          var qStr =
            'INSERT INTO step_companies (step_id, company_id) VALUES ('
          + db.escape(step_id) + ','
          + db.escape(args.company_id) + ')'
          ;
          db.queryData(qStr, cb);
        });
      });
    },
    cb);
  }

  function deleteTestHouse(peodb, db, args, cb) {
    db.transaction(function(cb) {
      // find the tp_rev's step_id
      var qArgs = { db: db, tp_rev_id: args.tp_rev_id };
      peodb.getTPrevStepID(qArgs, function(err, step_id) {
        if (err) {
          return cb(err);
        }
        var qStr =
          'DELETE FROM step_companies'
        + ' WHERE step_id    = ' + db.escape(step_id)
        + '   AND company_id = ' + db.escape(args.company_id)
        ;
        db.queryData(qStr, cb);
      });
    },
    cb);
  }
}

//============================================================================//
