//============================================================================//

var print = console.log;

//============================================================================//

var queryBasis =
  'SELECT'
+ '  b.blob_id'
+ ', b.blob_type_id'
+ ', b.object_id'
+ ', b.user_id'
+ ', b.create_time'
+ ', b.version'
+ ', b.active'
+ ', b.name'
+ ', b.orig_name'
+ ', b.data_encoding'
+ ', b.length'
+ ', b.mimetype'
+ ', bt.name AS type_name'
+ ', bt.abbr AS type_abbr'
+ ', u.name  AS user_name'
+ ' FROM blobs b'
+ ' LEFT JOIN blob_types bt ON (bt.blob_type_id = b.blob_type_id)'
+ ' JOIN users u ON (u.user_id = b.user_id)'
;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    // 'object_id',
    // 'user_id',
    // 'name',
    // 'data',
    // 'type_abbr',
    // 'active',
    // 'lastest',  - boolean
  ];

  PEODB.prototype.getBlobs = function(args, cb) {
    var peodb = this;
    if (typeof(args) === 'function') {
      cb = args;
      args = {};
    }
    getBlobs(peodb.sharedDB, args, null, cb);
  }

  PEODB.prototype.getPartBlobs = function(args, cb) {
    var peodb = this;
    if (typeof(args) === 'function') {
      cb = args;
      args = {};
    }
    getBlobs(peodb.sharedDB, args, 'part', cb);
  }

  PEODB.prototype.getStepBlobs = function(args, cb) {
    var peodb = this;
    if (typeof(args) === 'function') {
      cb = args;
      args = {};
    }
    getBlobs(peodb.sharedDB, args, 'step', cb);
  }

  function getBlobs(db, args, prefix, cb) {
    var qStr = queryBasis;
    if (args.latest) {
      qStr +=
        ' LEFT JOIN blobs b2'
      + ' ON ((b.name         = b2.name)'
      + ' AND (b.object_id    = b2.object_id)'
      + ' AND (b.blob_type_id = b2.blob_type_id)'
      + ' AND (b.version < b2.version))'
      ;
    }

    qStr += ' WHERE 1 = 1'

    if (args.latest) {
      qStr += ' AND b2.blob_id IS NULL';
    }

    function andClause(field, sqlField) {
      sqlField = sqlField || ('b.' + field);
      var value = args[field];
      if (value instanceof Array) {
        var array = [];
        for (var i = 0; i < value.length; i++) {
          array.push(db.escape(value[i]));
        }
        qStr += ' AND ' + sqlField + ' IN (' + arr.join(',') + ')';
      }
      else if (typeof(value) !== 'undefined') {
        qStr += ' AND ' + sqlField + ' = ' + db.escape(value);
      }
    }
    andClause('blob_id');
    andClause('object_id');
    andClause('user_id');
    andClause('name');
    andClause('data');
    andClause('version');
    andClause('active');
    andClause('type_abbr', 'bt.abbr');
    if (args.has_blob_type) {
      qStr += ' AND NOT ISNULL(b.blob_type_id)';
    }

    return db.queryData(qStr, cb);
  }
}

//============================================================================//
