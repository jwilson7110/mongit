//============================================================================//

var print = console.log;

//============================================================================//

var queryBasis =
  'SELECT'
+ '   ro.object_id'
+ ' , ro.user_id'
+ ' , u.name'
+ ' , u.phone'
+ ' , u.mobile'
+ ' , u.email'
+ ' , u.location'
+ ' , rt.role_type_id'
+ ' , rt.brief         AS role_type_brief'
+ ' , rt.description   AS role_type_desc'
+ ' , rt.display_order AS role_type_display_order'
+ ' FROM object_roles ro'
+ ' JOIN users        u  ON (u.user_id       = ro.user_id)'
+ ' JOIN role_types   rt ON (rt.role_type_id = ro.role_type_id)'
;

//============================================================================//

module.exports = function(PEODB) {

  //==========================================================================//

  function getObjectRoles(peodb, args, object_id, cb) {

    var db = args.db ? args.db : peodb.sharedDB;

    var qStr = queryBasis + ' WHERE ro.object_id = ' + db.escape(object_id);

    if (args.user_id) {
      qStr += ' AND ro.user_id = ' + db.escape(args.user_id);
    }
    if (args.role_type_id) {
      qStr += ' AND ro.role_type_id = ' + db.escape(args.role_type_id);
    }

    return db.queryData(qStr, cb);
  }

  //==========================================================================//

  PEODB.prototype.getObjectRoles = function(args, type, cb) {
    var peodb = this;
    peodb.getObjectID(args, type, function(err, object_id) {
      if (err) {
        return cb(err);
      }
      getObjectRoles(peodb, args, object_id, cb);
    });
  }

  //==========================================================================//
  //
  //  role access (by object type)
  //

  var types = [
    { objFunc: 'getPartflowObjectID',   roleFunc: 'getPartflowRoles'   },
    { objFunc: 'getPartObjectID',       roleFunc: 'getPartRoles'       },
    { objFunc: 'getStepObjectID',       roleFunc: 'getStepRoles'       },
    { objFunc: 'getTPsetObjectID',      roleFunc: 'getTPsetRoles'      },
    { objFunc: 'getTPObjectID',         roleFunc: 'getTPRoles'         },
    { objFunc: 'getTPrevObjectID',      roleFunc: 'getTPrevRoles'      },
    { objFunc: 'getFabProcessObjectID', roleFunc: 'getFabProcessRoles' },
  ];

  function genRoleFunc(objFunc) {
    return function(args, cb) {
      var peodb = this;
      peodb[objFunc](args, function(err, object_id) {
        if (err) {
          return cb(err);
        }
        getObjectRoles(peodb, args, object_id, cb);
      });
    }
  }

  for (var i = 0; i < types.length; i++) {
    var type = types[i];
    PEODB.prototype[type.roleFunc] = genRoleFunc(type.objFunc);
  }

  //==========================================================================//
}

//============================================================================//
