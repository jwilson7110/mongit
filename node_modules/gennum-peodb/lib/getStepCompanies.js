//============================================================================//

var print = console.log;

//============================================================================//

var queryBasis =
  'SELECT'
  + '     s.step_id'
  + '   , c.name'
  + '   , c.company_id'
  + '   , pc.name AS parent_name'
  + '   , COUNT(cn.company_id) AS contacts_count'
  + '   , COUNT(li.company_id) AS liaisons_count'
  + '   , NOT ISNULL(fd.company_id) AS is_foundry'
  + '   , NOT ISNULL(bh.company_id) AS is_bump_house'
  + '   , NOT ISNULL(th.company_id) AS is_test_house'
  + '   , NOT ISNULL(ah.company_id) AS is_assembly_house'
  + '   , NOT ISNULL(av.company_id) AS is_ate_vendor'
  + ' FROM'
  + '        step_companies        s'
  + '        JOIN companies        c  ON (c.company_id  = s.company_id)'
  + '   LEFT JOIN companies        pc ON (pc.company_id = c.parent_company_id)'
  + '   LEFT JOIN foundries        fd ON (fd.company_id = c.company_id)'
  + '   LEFT JOIN bump_houses      bh ON (bh.company_id = c.company_id)'
  + '   LEFT JOIN test_houses      th ON (th.company_id = c.company_id)'
  + '   LEFT JOIN assembly_houses  ah ON (ah.company_id = c.company_id)'
  + '   LEFT JOIN ate_vendors      av ON (av.company_id = c.company_id)'
  + '   LEFT JOIN contacts         cn ON (cn.company_id = c.company_id)'
  + '   LEFT JOIN company_liaisons li ON (li.company_id = c.company_id)'
  ;


module.exports = function(PEODB) {

  var requiredArgs = [
    'step_id',
  ];

  PEODB.prototype.getStepCompanies = function(args, cb) { // FIXME -- needs work
    var peodb = this;

    if (!(args instanceof Object)) {
      args = { step_id: args };
    }

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    getStepCompanies(peodb.sharedDB, args, cb);
  }

  function getStepCompanies(db, args, cb) {
    var qStr =
      queryBasis
      + ' WHERE'
      + '   s.step_id = ' + db.escape(args.step_id)
      + ' GROUP BY c.company_id'
      ;
    db.queryData(qStr, cb);
  }
}

//============================================================================//
