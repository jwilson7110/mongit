//============================================================================//

var print = console.log;

//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'tp_rev_id',
    'user_id',
    'type_abbr',
    'file_path',
    'file_name',
    'file_size',
  ];

  PEODB.prototype.setTPrevDatalog = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing required argument: ' + missingArg));
    }

    peodb.dbSession(args, function(db, cb) {
      setTPrevDatalog(db, args, cb);
    }, cb);
  }

  function setTPrevDatalog(db, args, cb) {
    print('setTPrevDatalog', args); // FIXME

    var type_abbr = db.escape(args.type_abbr);
    var tp_rev_id = db.escape(args.tp_rev_id);
    var file_path = db.escape(args.file_path);
    var file_name = db.escape(args.file_name);
    var file_size = db.escape(args.file_size);

    db.transaction(function(cb) {
      var qStr =
        'UPDATE datalogs d'
      + ' JOIN datalog_types dt ON (dt.datalog_type_id = d.datalog_type_id)'
      + ' SET active = FALSE'
      + ' WHERE tp_rev_id = ' + tp_rev_id
      + '   AND dt.abbr = '   + type_abbr;
      ;
      db.queryData(qStr, function(err) {
        if (err) {
          return cb(err);
        }
        var activeStr = (args.file_name === '') ? 'FALSE' : 'TRUE';
        if (args.active === false) {
          return cb();
        }
        var typeSel =
          '(SELECT datalog_type_id FROM datalog_types'
        + ' WHERE abbr = ' + type_abbr + ')';
        var qStr =
          'INSERT INTO datalogs ('
        + ' datalog_id, datalog_type_id'
        + ', tp_rev_id, user_id, assign_time'
        + ', file_path, file_name, file_size'
        + ', active'
        + ') VALUES ('
        + 'NULL'
        + ',' + typeSel + ',' + tp_rev_id
        + ',' + db.escape(args.user_id)
        + ',UNIX_TIMESTAMP()'
        + ',' + file_path + ',' + file_name + ',' + file_size
        + ',' + activeStr
        + ')'
        ;
        db.queryData(qStr, function(err,data) {
          print(qStr, err, data); // FIXME
          return cb(err, data); // FIXME
        });
      });
    },
    cb);
  }
}

//============================================================================//
