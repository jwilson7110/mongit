//============================================================================//

var print = console.log;

var async = require('async');

//============================================================================//
//
//  testflags = [
//    { name: '...', value: '...', state: '...' },
//  ]
//
//============================================================================//

module.exports = function(PEODB) {

  var requiredArgs = [
    'user_id',
    'tp_rev_id',
    'state',
    'reason',
  ];

  //==========================================================================//

  PEODB.prototype.setTPrevState = function(args, cb) {
    var peodb = this;

    var missingArg = peodb.checkArgs(requiredArgs, args);
    if (missingArg) {
      return cb(Error('missing  argument: ' + missingArg));
    }

    peodb.dbSession(args, function(db, cb) {
      setTPrevState(db, args, cb);
    }, cb);
  }
}

//============================================================================//

function setTPrevState(db, args, cb) {
  db.transaction(function(cb) {
    var tp_rev_id = db.escape(args.tp_rev_id);
    var state = db.escape(args.state);

    var qStr =
      'INSERT INTO tp_rev_state_changes'
    + ' (tp_rev_id, change_time, user_id'
    + ', state_old, state_new, reason)'
    + ' VALUES '
    + '(' + tp_rev_id
    + ',UNIX_TIMESTAMP()'
    + ',' + db.escape(args.user_id)
    + ',(SELECT state FROM tp_revs WHERE tp_rev_id = ' + tp_rev_id + ')'
    + ',' + db.escape(args.state)
    + ',' + db.escape(args.reason)
    + ')'
    ;
    db.queryData(qStr, function(err) {
      if (err) {
        return cb(err);
      }

      var qStr =
        'UPDATE tp_revs'
      + ' SET state = ' + state
      + ' , task_handle = NULL'
      + ' , task_error = NULL'
      + ' , task_time = NULL'
      + ' WHERE tp_rev_id = ' + tp_rev_id
      ;
      db.queryData(qStr, cb);
    });
  },
  cb);
}

//============================================================================//
