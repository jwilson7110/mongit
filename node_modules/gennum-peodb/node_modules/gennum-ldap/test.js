#!/usr/bin/env node

var ldap = require('gennum-ldap');

function getNamePass(cb) {
  var username = null;
  var password = null;
  process.stdout.write('username: ');
  process.stdin.resume();
  process.stdin.on('data', stdinData);
  function stdinData(data) {
    data = data.toString().replace(/\n.*$/, '');
    if (data !== null) {
      if (username === null) {
        username = data;
        process.stdout.write('password: ');
      }
      else if (password === null) {
        password = data;
        process.stdin.removeListener('on', stdinData);
        process.stdin.pause();
        var usertmp = username;
        var passtmp = password;
        username = null;
        password = null;
        cb(usertmp, passtmp);
      }
    }
  }
}

ldap.getUserList(function(err, data) {

  try {
    require('console.log');
  } catch (e) {
    // ignore it, nice to have is all...
  }
  var print = console.log;


  if (err) {
    print('getUserList-error', err);
    return;
  }
  for (var i = 0; i < data.length; i++) {
    print('list-entry[' + i + '] ', data[i]);
  }

  print();
  ldap.getUserInfoByCallsign('darodger', function(err, data) {
    if (err) {
      print('getUserInfoByCallsign-error', err);
      return;
    }
    print('getUserInfoByCallsign-data', data);

    print();
    ldap.getUserInfoByID(5309, function(err, data) {
      if (err) {
        print('getUserInfoByID-error', err);
        return;
      }
      print('getUserInfoByID-data', data);

      print();
      var dn = 'CN=Ray Steiger,CN=Users,DC=ad,DC=gennum,DC=com';
      ldap.getUserInfoByDN(dn, function(err, data) {
        if (err) {
          print('getUserInfoByDN-error', err);
          return;
        }
        print('getUserInfoByDN-data', data);

        (function loopLoginCheck() {
          getNamePass(function(username, password) {
            print('username = ', username.length, username, typeof(username));
            print('password = ', password.length, password, typeof(password));
            ldap.checkLogin(username, password, function(err, data) {
              print('getNamePass', err, data);
              loopLoginCheck();
            });
          });
        })();
      });
    });
  });
});
