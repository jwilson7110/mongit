################################################################################
#
#  Audits
#

CREATE TABLE `audit_types` ( -- LIST-TABLE
  `audit_type_id`       INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
, `manual`              BOOLEAN      NOT NULL
, `name`                VARCHAR(32)  NOT NULL
, `brief`               VARCHAR(64)  NOT NULL
, `description`         TEXT         NOT NULL
, `tp_rev_state`        VARCHAR(16)  NOT NULL
, `is_signoff`          BOOLEAN      NOT NULL
, `tp_type_regexp`      TEXT -- JS RegExp against tp_type.abbr
, `tp_stage_regexp`     TEXT -- JS RegExp against tp_stage.abbr
, `ate_type_regexp`     TEXT -- JS RegExp against ate_types.abbr
, `role_regexp`         TEXT -- JS RegExp against role_type.brief
, `display_order`       FLOAT NOT NULL
, UNIQUE  KEY (`name`)
, FOREIGN KEY (`tp_rev_state`) REFERENCES `tp_rev_states` (`name`)
);


CREATE TABLE `audits` (
  `audit_id`            INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
, `audit_type_id`       INT UNSIGNED NOT NULL
, `tp_rev_id`           INT UNSIGNED NOT NULL
, UNIQUE  KEY (`audit_type_id`, `tp_rev_id`)
, FOREIGN KEY (`audit_type_id`) REFERENCES `audit_types` (`audit_type_id`)
, FOREIGN KEY (`tp_rev_id`)     REFERENCES `tp_revs`     (`tp_rev_id`)
);


CREATE TABLE `audit_signoffs` ( -- TIE-TABLE
  `audit_id`            INT UNSIGNED NOT NULL
, `signoff_id`          INT UNSIGNED NOT NULL
, PRIMARY KEY (`audit_id`, `signoff_id`)
, FOREIGN KEY (`audit_id`)   REFERENCES `audits`   (`audit_id`)
, FOREIGN KEY (`signoff_id`) REFERENCES `signoffs` (`signoff_id`)
);

################################################################################
#
#  audit creation tables
#

CREATE TABLE `audit_role_types` ( -- TIE-TABLE
  `audit_type_id`       INT UNSIGNED NOT NULL
, `role_type_id`        INT UNSIGNED NOT NULL
, PRIMARY KEY (`audit_type_id`, `role_type_id`)
, FOREIGN KEY (`audit_type_id`) REFERENCES `audit_types` (`audit_type_id`)
, FOREIGN KEY (`role_type_id`)  REFERENCES `role_types`  (`role_type_id`)
);


################################################################################
