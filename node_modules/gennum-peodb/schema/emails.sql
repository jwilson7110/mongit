################################################################################
#
#  Roles
#

CREATE TABLE `email_types` (
  `email_type`          VARCHAR(16) NOT NULL PRIMARY KEY
);

################################################################################

CREATE TABLE `emails` (
  `email_id`            INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
, `email_type`          VARCHAR(16)  NOT NULL
, `create_time`         DOUBLE       NOT NULL -- TIME_T
, `sent_time`           DOUBLE                -- TIME_T
, `completed`           BOOLEAN      NOT NULL DEFAULT FALSE
, `attempts`            INT UNSIGNED NOT NULL DEFAULT 0
, `last_error`          TEXT
, `from_address`        TEXT NOT NULL
, `reply_to`            TEXT
, `subject`             TEXT NOT NULL
, `data_text`           TEXT
, `data_html`           TEXT
, FOREIGN KEY (`email_type`) REFERENCES `email_types` (`email_type`)
);

################################################################################

CREATE TABLE `email_recipients` (
  `email_id`            INT UNSIGNED NOT NULL
, `address`             VARCHAR(128) NOT NULL
, `recipient_type`      ENUM('TO', 'CC', 'BCC') NOT NULL
, `sent_time`           DOUBLE -- TIME_T
, `attempts`            INT UNSIGNED NOT NULL DEFAULT 0
, `last_error`          TEXT
, PRIMARY KEY (`email_id`, `address`)
, FOREIGN KEY (`email_id`) REFERENCES `emails` (`email_id`)
);


################################################################################

CREATE TABLE `email_attachments` (
  `email_attachment_id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
, `email_id`            INT UNSIGNED NOT NULL
, `data`                LONGBLOB     NOT NULL
, `data_encoding`       VARCHAR(16)  NOT NULL -- ex: 'base64'
, `file_name`           VARCHAR(255)
, `cid`                 VARCHAR(16)
, `length`              INT UNSIGNED NOT NULL -- unencoded length
, `mimetype`            VARCHAR(64)
, FOREIGN KEY (`email_id`)       REFERENCES `emails` (`email_id`)
);

################################################################################
