################################################################################

CREATE TABLE `partflows` ( -- LIST-TABLE
  `partflow_id`         INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY
, `object_id`           INT UNSIGNED NOT NULL
, `root_part_id`        INT UNSIGNED NOT NULL
, `name`                VARCHAR(64)  NOT NULL
, `description`         TEXT         NOT NULL
, `render_hints`        TEXT
, `locked`              BOOLEAN      NOT NULL DEFAULT TRUE
, FOREIGN KEY (`object_id`)    REFERENCES `objects` (`object_id`)
, FOREIGN KEY (`root_part_id`) REFERENCES `parts`   (`part_id`)
, UNIQUE KEY (`name`)
);

################################################################################

CREATE TABLE `partflow_parts` ( -- TIE-TABLE
  `partflow_id`         INT UNSIGNED NOT NULL
, `part_id`             INT UNSIGNED NOT NULL
, PRIMARY KEY (`partflow_id`, `part_id`)
, FOREIGN KEY (`partflow_id`) REFERENCES `partflows` (`partflow_id`)
, FOREIGN KEY (`part_id`)     REFERENCES `parts`     (`part_id`)
);

CREATE TABLE `partflow_steps` ( -- TIE-TABLE
  `partflow_id`         INT UNSIGNED NOT NULL
, `step_id`             INT UNSIGNED NOT NULL
, PRIMARY KEY (`partflow_id`, `step_id`)
, UNIQUE  KEY (`step_id`)
, FOREIGN KEY (`partflow_id`) REFERENCES `partflows` (`partflow_id`)
, FOREIGN KEY (`step_id`)     REFERENCES `steps`     (`step_id`)
);

################################################################################
#
#  This table is being used to simplify getPartParents() and getPartChildren()
#

CREATE TABLE `partflow_sources` ( -- TIE-TABLE -- FIXME - unused
  `src_partflow_id`     INT UNSIGNED NOT NULL
, `dst_partflow_id`     INT UNSIGNED NOT NULL
, PRIMARY KEY (`src_partflow_id`, `dst_partflow_id`)
, FOREIGN KEY (`src_partflow_id`) REFERENCES `partflows` (`partflow_id`)
, FOREIGN KEY (`dst_partflow_id`) REFERENCES `partflows` (`partflow_id`)
);

INSERT INTO dbdoc(`table_name`, `field_name`, `description`) VALUES
  ("partflow_sources", NULL, "partflow_sources: all source partflows for a given destination partflow")
, ("partflow_sources", "dst_partflow_id", "destination partflow")
, ("partflow_sources", "src_partflow_id", "source partflow")
;

################################################################################
#
#  Connects a part between two different partflows
#

CREATE TABLE `partflow_connectors` ( -- TIE-TABLE -- FIXME - unused
  `part_id`             INT UNSIGNED NOT NULL
, `src_partflow_id`     INT UNSIGNED NOT NULL
, `dst_partflow_id`     INT UNSIGNED NOT NULL
, PRIMARY KEY (`part_id`, `src_partflow_id`, `dst_partflow_id`)
, FOREIGN KEY (`part_id`)         REFERENCES `parts`     (`part_id`)
, FOREIGN KEY (`src_partflow_id`) REFERENCES `partflows` (`partflow_id`)
, FOREIGN KEY (`dst_partflow_id`) REFERENCES `partflows` (`partflow_id`)
);

################################################################################
