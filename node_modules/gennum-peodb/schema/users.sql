################################################################################
#
#  Users  (Gennum employees, identified by their LDAP employeeNumber field)
#

CREATE TABLE `users` (
  `user_id`             INT SIGNED NOT NULL PRIMARY KEY
, `ldap_id`             VARCHAR(255)
, `name`                VARCHAR(255) NOT NULL
, `callsign`            VARCHAR(255)
, `phone`               VARCHAR(255)
, `mobile`              VARCHAR(255)
, `email`               VARCHAR(255)
, `fax`                 VARCHAR(255)
, `title`               VARCHAR(255)
, `location`            VARCHAR(255)
, `manager_id`          INT SIGNED
, `state`               ENUM('ACTIVE', 'OBSOLETE') NOT NULL
,  UNIQUE  KEY (`ldap_id`)
,  UNIQUE  KEY (`callsign`)
,  FOREIGN KEY (`manager_id`) REFERENCES `users` (`user_id`)
);

INSERT INTO dbdoc(`table_name`, `field_name`, `description`) VALUES
  ("users", NULL,         "system users (Gennum employees, for the most part)")
, ("users", "user_id",    "primary key")
, ("users", "ldap_id",    "LDAP employeeNumber value (or NULL for robots)")
, ("users", "name",       "the user's real name")
, ("users", "callsign",   "the user's login name")
, ("users", "phone",      "user's work phone number, ex: '(613) 270-0458 x2763'")
, ("users", "mobile",     "user's mobile phone number, ex: '(613) 555-1234")
, ("users", "email",      "user's email address, ex: david.rodgers@semtech.com")
, ("users", "fax",        "user's fax machine -- so 1980's")
, ("users", "title",      "user's title")
, ("users", "location",   "user's work site")
, ("users", "manager_id", "user's manager")
;

################################################################################

CREATE TABLE `user_hashes` (
  `user_id`             INT SIGNED NOT NULL PRIMARY KEY
, `passhash`            VARCHAR(255)
, `passtime`            INT UNSIGNED
,  FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`)
);

INSERT INTO dbdoc(`table_name`, `field_name`, `description`) VALUES
  ("user_hashes", NULL,         "seeded SHA256 hashes of users password")
, ("user_hashes", "user_id",    "primary key - and foreign key into `users`")
, ("user_hashes", "passhash",   "a hash of the most recent successful login")
, ("user_hashes", "passtime",   "when the passhash was generated")
;

################################################################################

CREATE TABLE `user_settings` (
  `user_id`             INT SIGNED  NOT NULL
, `setting`             VARCHAR(64) NOT NULL
, `data`                TEXT
,  PRIMARY KEY (`user_id`, `setting`)
,  FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`)
);

INSERT INTO dbdoc(`table_name`, `field_name`, `description`) VALUES
  ("user_settings", NULL,       "generic users settings table")
, ("user_settings", "user_id",  "foreign key into `users`")
, ("user_settings", "setting",  "the setting's name")
, ("user_settings", "data",     "the data for a user setting")
;

################################################################################

ALTER TABLE `objects` ADD FOREIGN KEY (`create_user_id`)
  REFERENCES `users` (`user_id`);

################################################################################


